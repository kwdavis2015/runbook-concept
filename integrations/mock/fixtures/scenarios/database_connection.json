{
  "scenario": "database_connection_exhaustion",
  "description": "Connection pool on db-primary-01 exhausted by new microservice deployed without connection pooling",

  "servicenow": {
    "incident": {
      "id": "INC0012400",
      "number": "INC0012400",
      "title": "Database connection pool exhausted on db-primary-01",
      "short_description": "Database connection pool exhausted on db-primary-01",
      "description": "Applications reporting 'too many connections' errors against db-primary-01. Connection pool at 100% capacity. Multiple downstream services affected.",
      "status": "new",
      "severity": "critical",
      "category": "database",
      "assigned_to": "Mike Chen",
      "created_at": "2026-01-20T14:10:00Z"
    },
    "recent_changes": [
      {
        "id": "CHG0004600",
        "number": "CHG0004600",
        "description": "Deploy inventory-service v1.0.0 to production",
        "status": "closed",
        "created_at": "2026-01-20T13:00:00Z",
        "closed_at": "2026-01-20T13:25:00Z",
        "requested_by": "deploy-bot",
        "category": "deployment"
      },
      {
        "id": "CHG0004595",
        "number": "CHG0004595",
        "description": "Scale up order-service replicas from 3 to 5",
        "status": "closed",
        "created_at": "2026-01-20T10:00:00Z",
        "closed_at": "2026-01-20T10:15:00Z",
        "requested_by": "auto-scaler",
        "category": "scaling"
      }
    ],
    "knowledge_base": [
      {
        "id": "KB0001300",
        "title": "Database Connection Pool Troubleshooting",
        "content": "When connections are exhausted: 1) Identify which application holds the most connections, 2) Check for recent deployments of new services, 3) Verify connection pooling configuration, 4) Temporarily increase max_connections if needed.",
        "category": "database",
        "relevance_score": 0.97
      }
    ]
  },

  "datadog": {
    "alerts": [
      {
        "id": "alert-db-001",
        "name": "Database Connections Critical",
        "host": "db-primary-01",
        "value": 100.0,
        "threshold": 90.0,
        "status": "triggered",
        "severity": "critical",
        "triggered_at": "2026-01-20T14:08:00Z",
        "tags": {"env": "production", "service": "postgresql", "team": "data"}
      },
      {
        "id": "alert-app-001",
        "name": "Application Error Rate Elevated",
        "host": "order-service",
        "value": 15.3,
        "threshold": 5.0,
        "status": "triggered",
        "severity": "high",
        "triggered_at": "2026-01-20T14:09:00Z",
        "tags": {"env": "production", "service": "order-service", "team": "commerce"}
      }
    ],
    "metrics": {
      "db_connections": [
        {"timestamp": "2026-01-20T13:00:00Z", "value": 45.0},
        {"timestamp": "2026-01-20T13:15:00Z", "value": 48.0},
        {"timestamp": "2026-01-20T13:30:00Z", "value": 68.0},
        {"timestamp": "2026-01-20T13:45:00Z", "value": 85.0},
        {"timestamp": "2026-01-20T14:00:00Z", "value": 98.0},
        {"timestamp": "2026-01-20T14:10:00Z", "value": 100.0}
      ],
      "error_rate": [
        {"timestamp": "2026-01-20T13:00:00Z", "value": 0.1},
        {"timestamp": "2026-01-20T13:15:00Z", "value": 0.2},
        {"timestamp": "2026-01-20T13:30:00Z", "value": 1.5},
        {"timestamp": "2026-01-20T13:45:00Z", "value": 5.8},
        {"timestamp": "2026-01-20T14:00:00Z", "value": 12.4},
        {"timestamp": "2026-01-20T14:10:00Z", "value": 15.3}
      ]
    },
    "logs": [
      {
        "timestamp": "2026-01-20T14:09:00Z",
        "level": "error",
        "host": "order-service-pod-3",
        "service": "order-service",
        "message": "FATAL: too many connections for role \"app_user\"",
        "attributes": {"db_host": "db-primary-01", "max_connections": 200}
      },
      {
        "timestamp": "2026-01-20T14:05:00Z",
        "level": "error",
        "host": "checkout-service-pod-1",
        "service": "checkout-service",
        "message": "Connection pool exhausted — unable to acquire connection within 30s timeout",
        "attributes": {"pool_size": 20, "active": 20, "waiting": 14}
      },
      {
        "timestamp": "2026-01-20T13:30:00Z",
        "level": "warning",
        "host": "db-primary-01",
        "service": "postgresql",
        "message": "Connection count approaching limit: 136/200 active connections",
        "attributes": {"active": 136, "max": 200}
      },
      {
        "timestamp": "2026-01-20T13:25:00Z",
        "level": "info",
        "host": "inventory-service-pod-1",
        "service": "inventory-service",
        "message": "Service started successfully. Connecting to database db-primary-01.",
        "attributes": {"version": "1.0.0", "deploy_id": "CHG0004600"}
      }
    ],
    "host_info": {
      "hostname": "db-primary-01",
      "instance_id": "i-0db1234abc567",
      "instance_type": "r5.2xlarge",
      "state": "running",
      "ip_address": "10.0.2.10",
      "region": "us-east-1",
      "tags": {"env": "production", "service": "postgresql", "role": "primary"}
    }
  },

  "pagerduty": {
    "incidents": [
      {
        "id": "P2345",
        "title": "Database connection pool exhausted — db-primary-01",
        "status": "triggered",
        "urgency": "high",
        "service": "Database Tier",
        "assigned_to": "Mike Chen",
        "created_at": "2026-01-20T14:08:00Z"
      }
    ],
    "on_call": {
      "user": "Mike Chen",
      "schedule": "Database On-Call",
      "start": "2026-01-20T08:00:00Z",
      "end": "2026-01-21T08:00:00Z",
      "escalation_level": 1
    }
  },

  "aws": {
    "instance": {
      "hostname": "db-primary-01",
      "instance_id": "i-0db1234abc567",
      "instance_type": "r5.2xlarge",
      "state": "running",
      "ip_address": "10.0.2.10",
      "region": "us-east-1",
      "tags": {"env": "production", "service": "postgresql", "role": "primary", "Name": "db-primary-01"}
    },
    "top_processes": [
      {"pid": 5001, "name": "postgres", "cpu_percent": 45.2, "memory_percent": 38.4, "user": "postgres", "command": "postgres: primary process"},
      {"pid": 5200, "name": "postgres", "cpu_percent": 12.1, "memory_percent": 8.2, "user": "postgres", "command": "postgres: inventory-service app_user idle"},
      {"pid": 5201, "name": "postgres", "cpu_percent": 11.8, "memory_percent": 7.9, "user": "postgres", "command": "postgres: inventory-service app_user idle"},
      {"pid": 5100, "name": "postgres", "cpu_percent": 5.3, "memory_percent": 4.1, "user": "postgres", "command": "postgres: order-service app_user active"},
      {"pid": 9001, "name": "node_exporter", "cpu_percent": 0.2, "memory_percent": 0.1, "user": "prometheus", "command": "/usr/bin/node_exporter"}
    ]
  },

  "slack": {
    "channels": [
      {"id": "C001", "name": "incidents", "purpose": "Active incident coordination"},
      {"id": "C003", "name": "database-alerts", "purpose": "Database team alerts"}
    ],
    "recent_messages": [
      {"id": "msg-010", "channel": "database-alerts", "text": ":rotating_light: CRITICAL: Database connections at 100% on db-primary-01 — all pools exhausted", "author": "Datadog Bot", "timestamp": "2026-01-20T14:08:00Z"},
      {"id": "msg-011", "channel": "database-alerts", "text": ":warning: Application error rate spiking on order-service (15.3%, threshold 5%)", "author": "Datadog Bot", "timestamp": "2026-01-20T14:09:00Z"}
    ]
  }
}
